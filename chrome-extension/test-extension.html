<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰©å±•æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Consolas', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }
        .test-result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #4caf50;
            background: #252526;
        }
        .success { border-left-color: #4caf50; }
        .error { border-left-color: #f44336; }
        .warning { border-left-color: #ff9800; }
        h1 { color: #667eea; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1177bb; }
        .log {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ“¡ SignalR Monitor æ‰©å±•æµ‹è¯•</h1>

    <div id="results"></div>

    <h2>æµ‹è¯•æ“ä½œ</h2>
    <button onclick="testExtensionInjection()">1. æµ‹è¯•æ‰©å±•æ³¨å…¥</button>
    <button onclick="testSignalRAvailable()">2. æµ‹è¯•SignalRå¯ç”¨æ€§</button>
    <button onclick="testContentScript()">3. æµ‹è¯•Content Script</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>

    <h2>æ§åˆ¶å°æ—¥å¿—</h2>
    <div class="log" id="log"></div>

    <script>
        const results = document.getElementById('results');
        const logEl = document.getElementById('log');

        function addResult(title, message, type = 'success') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong><br>${message}`;
            results.appendChild(div);
        }

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.style.color = type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#d4d4d4';
            entry.textContent = `[${time}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            logEl.innerHTML = '';
            results.innerHTML = '';
        }

        // ç›‘å¬æ¥è‡ªæ‰©å±•çš„æ¶ˆæ¯
        window.addEventListener('message', (event) => {
            if (event.data.source === 'signalr-monitor') {
                log(`ğŸ“¥ æ”¶åˆ°æ‰©å±•æ¶ˆæ¯: ${event.data.type}`, 'success');
                console.log('Extension message:', event.data);
            }
        });

        function testExtensionInjection() {
            log('æµ‹è¯•æ‰©å±•è„šæœ¬æ³¨å…¥...');

            // æ£€æŸ¥æ˜¯å¦æœ‰æ¥è‡ªæ‰©å±•çš„æ¶ˆæ¯ç›‘å¬å™¨
            let hasListener = false;

            // å‘é€æµ‹è¯•æ¶ˆæ¯
            window.postMessage({
                source: 'signalr-monitor-test',
                type: 'PING'
            }, '*');

            setTimeout(() => {
                if (window.signalR) {
                    addResult(
                        'âœ… SignalRå·²åŠ è½½',
                        'window.signalR å¯¹è±¡å­˜åœ¨ï¼Œæ‰©å±•å¯ä»¥Hook SignalR',
                        'success'
                    );
                    log('âœ“ SignalRå·²åŠ è½½', 'success');
                } else {
                    addResult(
                        'âŒ SignalRæœªåŠ è½½',
                        'é¡µé¢ä¸Šæ²¡æœ‰SignalRåº“ï¼Œæ‰©å±•æ— æ³•å·¥ä½œ',
                        'error'
                    );
                    log('âœ— SignalRæœªåŠ è½½', 'error');
                }
            }, 1000);
        }

        function testSignalRAvailable() {
            log('æµ‹è¯•SignalRè¿æ¥...');

            if (!window.signalR) {
                addResult('âŒ SignalRä¸å¯ç”¨', 'è¯·å…ˆåŠ è½½SignalRåº“', 'error');
                log('âœ— SignalRä¸å¯ç”¨', 'error');
                return;
            }

            addResult(
                'âœ… SignalRå¯ç”¨',
                `ç‰ˆæœ¬: ${window.signalR.VERSION || 'æœªçŸ¥'}`,
                'success'
            );
            log(`âœ“ SignalRç‰ˆæœ¬: ${window.signalR.VERSION || 'æœªçŸ¥'}`, 'success');

            // æ£€æŸ¥HubConnectionBuilderæ˜¯å¦è¢«Hook
            const builder = new window.signalR.HubConnectionBuilder();
            log('âœ“ HubConnectionBuilderåˆ›å»ºæˆåŠŸ', 'success');
        }

        function testContentScript() {
            log('æµ‹è¯•Content Scripté€šä¿¡...');

            // å°è¯•å‘é€æ¶ˆæ¯åˆ°content script
            window.postMessage({
                source: 'test-page',
                type: 'TEST_MESSAGE',
                data: { test: true }
            }, '*');

            addResult(
                'â„¹ï¸ æ¶ˆæ¯å·²å‘é€',
                'å·²å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°Content Scriptï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°',
                'warning'
            );
            log('âœ“ æµ‹è¯•æ¶ˆæ¯å·²å‘é€', 'success');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.onload = () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æµ‹è¯•...', 'info');
            setTimeout(testExtensionInjection, 500);
        };
    </script>
</body>
</html>
